var RTQ=(()=>{var $=Object.create;var R=Object.defineProperty,G=Object.defineProperties,j=Object.getOwnPropertyDescriptor,W=Object.getOwnPropertyDescriptors,K=Object.getOwnPropertyNames,S=Object.getOwnPropertySymbols,J=Object.getPrototypeOf,N=Object.prototype.hasOwnProperty,V=Object.prototype.propertyIsEnumerable;var P=(i,t,a)=>t in i?R(i,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):i[t]=a,I=(i,t)=>{for(var a in t||(t={}))N.call(t,a)&&P(i,a,t[a]);if(S)for(var a of S(t))V.call(t,a)&&P(i,a,t[a]);return i},q=(i,t)=>G(i,W(t)),B=i=>R(i,"__esModule",{value:!0});var X=(i,t)=>()=>(t||i((t={exports:{}}).exports,t),t.exports),z=(i,t)=>{B(i);for(var a in t)R(i,a,{get:t[a],enumerable:!0})},Z=(i,t,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let p of K(t))!N.call(i,p)&&p!=="default"&&R(i,p,{get:()=>t[p],enumerable:!(a=j(t,p))||a.enumerable});return i},tt=i=>Z(B(R(i!=null?$(J(i)):{},"default",i&&i.__esModule&&"default"in i?{get:()=>i.default,enumerable:!0}:{value:i,enumerable:!0})),i);var F=X((rt,O)=>{var b=(()=>{var i=Object.defineProperty,t=Object.getOwnPropertySymbols,a=Object.prototype.hasOwnProperty,p=Object.prototype.propertyIsEnumerable,f=(s,r,h)=>r in s?i(s,r,{enumerable:!0,configurable:!0,writable:!0,value:h}):s[r]=h,T=(s,r)=>{for(var h in r||(r={}))a.call(r,h)&&f(s,h,r[h]);if(t)for(var h of t(r))p.call(r,h)&&f(s,h,r[h]);return s},l=s=>i(s,"__esModule",{value:!0}),_=(s,r)=>{l(s);for(var h in r)i(s,h,{get:r[h],enumerable:!0})},m={};_(m,{DEFAULT_UUID_LENGTH:()=>y,default:()=>o});var n="4.4.4",y=6,w={dictionary:"alphanum",shuffle:!0,debug:!1,length:y},k=class extends Function{constructor(s={}){super();this.dictIndex=0,this.dictRange=[],this.lowerBound=0,this.upperBound=0,this.dictLength=0,this._digit_first_ascii=48,this._digit_last_ascii=58,this._alpha_lower_first_ascii=97,this._alpha_lower_last_ascii=123,this._hex_last_ascii=103,this._alpha_upper_first_ascii=65,this._alpha_upper_last_ascii=91,this._number_dict_ranges={digits:[this._digit_first_ascii,this._digit_last_ascii]},this._alpha_dict_ranges={lowerCase:[this._alpha_lower_first_ascii,this._alpha_lower_last_ascii],upperCase:[this._alpha_upper_first_ascii,this._alpha_upper_last_ascii]},this._alpha_lower_dict_ranges={lowerCase:[this._alpha_lower_first_ascii,this._alpha_lower_last_ascii]},this._alpha_upper_dict_ranges={upperCase:[this._alpha_upper_first_ascii,this._alpha_upper_last_ascii]},this._alphanum_dict_ranges={digits:[this._digit_first_ascii,this._digit_last_ascii],lowerCase:[this._alpha_lower_first_ascii,this._alpha_lower_last_ascii],upperCase:[this._alpha_upper_first_ascii,this._alpha_upper_last_ascii]},this._alphanum_lower_dict_ranges={digits:[this._digit_first_ascii,this._digit_last_ascii],lowerCase:[this._alpha_lower_first_ascii,this._alpha_lower_last_ascii]},this._alphanum_upper_dict_ranges={digits:[this._digit_first_ascii,this._digit_last_ascii],upperCase:[this._alpha_upper_first_ascii,this._alpha_upper_last_ascii]},this._hex_dict_ranges={decDigits:[this._digit_first_ascii,this._digit_last_ascii],alphaDigits:[this._alpha_lower_first_ascii,this._hex_last_ascii]},this.log=(...e)=>{let u=[...e];if(u[0]=`[short-unique-id] ${e[0]}`,this.debug===!0&&typeof console!="undefined"&&console!==null)return console.log(...u)},this.setDictionary=(e,u)=>{let d;if(e&&Array.isArray(e)&&e.length>1)d=e;else{d=[];let c;this.dictIndex=c=0;let E=`_${e}_dict_ranges`,C=this[E];Object.keys(C).forEach(L=>{let Y=L;for(this.dictRange=C[Y],this.lowerBound=this.dictRange[0],this.upperBound=this.dictRange[1],this.dictIndex=c=this.lowerBound;this.lowerBound<=this.upperBound?c<this.upperBound:c>this.upperBound;this.dictIndex=this.lowerBound<=this.upperBound?c+=1:c-=1)d.push(String.fromCharCode(this.dictIndex))})}if(u){let c=.5;d=d.sort(()=>Math.random()-c)}this.dict=d,this.dictLength=this.dict.length,this.counter=0},this.seq=()=>this.sequentialUUID(),this.sequentialUUID=()=>{let e,u,d="";e=this.counter;do u=e%this.dictLength,e=Math.trunc(e/this.dictLength),d+=this.dict[u];while(e!==0);return this.counter+=1,d},this.randomUUID=(e=this.uuidLength||y)=>{let u,d,c;if(e===null||typeof e=="undefined"||e<1)throw new Error("Invalid UUID Length Provided");let E=e>=0;for(u="",c=0;c<e;c+=1)d=parseInt((Math.random()*this.dictLength).toFixed(0),10)%this.dictLength,u+=this.dict[d];return u},this.availableUUIDs=(e=this.uuidLength)=>parseFloat(Math.pow([...new Set(this.dict)].length,e).toFixed(0)),this.approxMaxBeforeCollision=(e=this.availableUUIDs(this.uuidLength))=>parseFloat(Math.sqrt(Math.PI/2*e).toFixed(20)),this.collisionProbability=(e=this.availableUUIDs(this.uuidLength),u=this.uuidLength)=>parseFloat((this.approxMaxBeforeCollision(e)/this.availableUUIDs(u)).toFixed(20)),this.uniqueness=(e=this.availableUUIDs(this.uuidLength))=>{let u=parseFloat((1-this.approxMaxBeforeCollision(e)/e).toFixed(20));return u>1?1:u<0?0:u},this.getVersion=()=>this.version,this.stamp=e=>{if(typeof e!="number"||e<10)throw new Error("Param finalLength must be number greater than 10");let u=Math.floor(+new Date/1e3).toString(16),d=e-9,c=Math.round(Math.random()*(d>15?15:d)),E=this.randomUUID(d);return`${E.substr(0,c)}${u}${E.substr(c)}${c.toString(16)}`},this.parseStamp=e=>{if(e.length<10)throw new Error("Stamp length invalid");let u=parseInt(e.substr(e.length-1,1),16);return new Date(parseInt(e.substr(u,8),16)*1e3)};let r=T(T({},w),s);this.counter=0,this.debug=!1,this.dict=[],this.version=n;let{dictionary:h,shuffle:Q,length:H}=r;return this.uuidLength=H,this.setDictionary(h,Q),this.debug=r.debug,this.log(this.dict),this.log(`Generator instantiated with Dictionary Size ${this.dictLength}`),new Proxy(this,{apply:(e,u,d)=>this.randomUUID(...d)})}},o=k;return o.default=k,m})();typeof O!="undefined"&&(O.exports=b.default),typeof window!="undefined"&&(b=b.default)});var it={};z(it,{RTQAction:()=>D,RTQActionEnum:()=>U,RTQStatus:()=>g,RTQStatusEnum:()=>v,default:()=>x,version:()=>A});var M=tt(F());var v;(function(n){n.NEW="NEW",n.QUEUED="QUEUED",n.INITIATED="INITIATED",n.RETRIED="RETRIED",n.IN_PROGRESS="IN_PROGRESS",n.FAILED="FAILED",n.AWAITING_RETRY="AWAITING_RETRY",n.AWAITING_NEXT_RUN="AWAITING_NEXT_RUN",n.SUCCEEDED="SUCCEEDED"})(v||(v={}));var U;(function(a){a.MODIFY_TASK_STATUS="MODIFY_TASK_STATUS",a.MODIFY_QUEUE="MODIFY_QUEUE"})(U||(U={}));var A="1.0.0";var g=I({},v),D=I({},U),st={maxConcurrentTasks:0,errorHandler:async i=>console.log(i)},x=class{constructor(t){this.runningTasks=0;this.ticking=!1;this.options=I(I({},st),t),this.uid=new M.default}async modifyTaskStatus({task:t,status:a,reason:p,triggeredBy:f,retryCount:T,lastRun:l}){let{options:{updateTask:_,eventHandler:m,errorHandler:n}}=this,y=q(I({},t),{status:a,retryCount:T||t.retryCount,lastRun:l||t.lastRun});return await _(y).then(()=>(m({timestamp:new Date,action:D.MODIFY_TASK_STATUS,message:`changed status of ${t.taskName} to ${a}`,reason:p||"",additionalData:{taskId:t.id,taskName:t.taskName,prevStatus:t.status,status:a},triggeredBy:f||"RTQ"}).catch(n),y)).catch(w=>(n(w),m({timestamp:new Date,action:D.MODIFY_TASK_STATUS,message:`failed changing status of ${t.taskName} to ${a}`,reason:p||"",additionalData:{taskId:t.id,taskName:t.taskName,prevStatus:t.status,status:a},triggeredBy:f||"RTQ"}).catch(n),null))}async queueTask(t,a,p){let{options:{createQueueEntry:f,eventHandler:T,errorHandler:l}}=this,_={id:this.uid.stamp(16),taskId:t.id,queuedAt:new Date};return await f(_).then(()=>{T({timestamp:new Date,action:D.MODIFY_QUEUE,message:`added queue entry ${_.id} to queue`,reason:"tick",additionalData:_,triggeredBy:"RTQ"}).catch(l)}).catch(n=>(l(n),null))===null?null:await this.modifyTaskStatus({task:t,status:g.QUEUED})}async processTask(t,a,p){this.runningTasks+=1;let{taskName:f,taskOptions:T,lastRun:l,waitTimeBetweenRuns:_,retryCount:m,maxRetries:n}=t;if(Date.now().valueOf()-l.valueOf()<_){await this.modifyTaskStatus({task:t,status:g.AWAITING_RETRY});return}let{options:{taskHandlers:w,errorHandler:k}}=this,o=g.INITIATED,s=m;s>0&&(o=g.RETRIED);let r=t;r=await this.modifyTaskStatus({task:r,status:o,retryCount:s}),r!==null&&(r=await this.modifyTaskStatus({task:r,status:g.IN_PROGRESS,lastRun:new Date}),r!==null&&w[f](T).then(async()=>{r=await this.modifyTaskStatus({task:r,status:g.SUCCEEDED,retryCount:0})}).catch(async h=>{k&&k(h).catch(console.log);let Q=g.AWAITING_RETRY;s>=n&&(Q=g.FAILED),s+=1,r=await this.modifyTaskStatus({task:r,status:Q,retryCount:s,reason:h.message||JSON.stringify(h)})}).finally(()=>{this.runningTasks-=1}))}async tick(){if(this.ticking)return;this.ticking=!0;let{options:{fetchTasks:t,fetchQueueEntries:a,removeQueueEntry:p,maxConcurrentTasks:f,eventHandler:T,errorHandler:l}}=this,_=await t().catch(l);if(!Array.isArray(_))return;let m=await a().catch(l);if(!Array.isArray(m))return;let n=m.sort((o,s)=>new Date(s.queuedAt).getTime()-new Date(o.queuedAt).getTime()).reduce((o,s)=>((f===0||o.length<f)&&o.push(s),o),[]);await Promise.all(n.map(async o=>await p(o).then(()=>{T({timestamp:new Date,action:D.MODIFY_QUEUE,message:`removed queue entry ${o.id} from queue`,reason:"tick",additionalData:o,triggeredBy:"RTQ"}).catch(l)}).catch(s=>{T({timestamp:new Date,action:D.MODIFY_QUEUE,message:`failed removing queue entry ${o.id} from queue`,reason:s.message||JSON.stringify(s),additionalData:{error:s},triggeredBy:"RTQ"}).catch(l),l(s)}))).catch(l);let y=n.map(o=>_.find(s=>s.id===o.taskId)),w=y.length;if(y.forEach((o,s,r)=>this.processTask(o,s,r)),_=await t().catch(l),!Array.isArray(_))return;let k=_.filter(o=>y.findIndex(s=>o.id===s.id)<0).filter(o=>o.status===g.NEW||o.status===g.AWAITING_RETRY||o.status===g.SUCCEEDED);await Promise.all(k.map(async(o,s,r)=>await this.queueTask(o,s,r).catch(h=>(l(h),null)))).then(o=>{this.ticking=!1,w<1&&k.length>0&&!o.includes(null)&&this.tick()}).catch(l)}};x.RTQStatus=g,x.version=A;return it;})();
'undefined'!=typeof module&&(module.exports=RTQ.default),'undefined'!=typeof window&&(RTQ=RTQ.default);