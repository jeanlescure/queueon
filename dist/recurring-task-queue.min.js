var RTQ=(()=>{var F=Object.create;var R=Object.defineProperty,M=Object.defineProperties,G=Object.getOwnPropertyDescriptor,$=Object.getOwnPropertyDescriptors,W=Object.getOwnPropertyNames,C=Object.getOwnPropertySymbols,Y=Object.getPrototypeOf,b=Object.prototype.hasOwnProperty,j=Object.prototype.propertyIsEnumerable;var O=(s,t,o)=>t in s?R(s,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):s[t]=o,E=(s,t)=>{for(var o in t||(t={}))b.call(t,o)&&O(s,o,t[o]);if(C)for(var o of C(t))j.call(t,o)&&O(s,o,t[o]);return s},P=(s,t)=>M(s,$(t)),N=s=>R(s,"__esModule",{value:!0});var J=(s,t)=>()=>(t||s((t={exports:{}}).exports,t),t.exports),V=(s,t)=>{N(s);for(var o in t)R(s,o,{get:t[o],enumerable:!0})},X=(s,t,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let _ of W(t))!b.call(s,_)&&_!=="default"&&R(s,_,{get:()=>t[_],enumerable:!(o=G(t,_))||o.enumerable});return s},z=s=>X(N(R(s!=null?F(Y(s)):{},"default",s&&s.__esModule&&"default"in s?{get:()=>s.default,enumerable:!0}:{value:s,enumerable:!0})),s);var L=J((et,A)=>{var Q=(()=>{var s=Object.defineProperty,t=Object.getOwnPropertySymbols,o=Object.prototype.hasOwnProperty,_=Object.prototype.propertyIsEnumerable,T=(i,a,u)=>a in i?s(i,a,{enumerable:!0,configurable:!0,writable:!0,value:u}):i[a]=u,k=(i,a)=>{for(var u in a||(a={}))o.call(a,u)&&T(i,u,a[u]);if(t)for(var u of t(a))_.call(a,u)&&T(i,u,a[u]);return i},d=i=>s(i,"__esModule",{value:!0}),p=(i,a)=>{d(i);for(var u in a)s(i,u,{get:a[u],enumerable:!0})},w={};p(w,{DEFAULT_UUID_LENGTH:()=>f,default:()=>n});var r="4.4.4",f=6,y={dictionary:"alphanum",shuffle:!0,debug:!1,length:f},m=class extends Function{constructor(i={}){super();this.dictIndex=0,this.dictRange=[],this.lowerBound=0,this.upperBound=0,this.dictLength=0,this._digit_first_ascii=48,this._digit_last_ascii=58,this._alpha_lower_first_ascii=97,this._alpha_lower_last_ascii=123,this._hex_last_ascii=103,this._alpha_upper_first_ascii=65,this._alpha_upper_last_ascii=91,this._number_dict_ranges={digits:[this._digit_first_ascii,this._digit_last_ascii]},this._alpha_dict_ranges={lowerCase:[this._alpha_lower_first_ascii,this._alpha_lower_last_ascii],upperCase:[this._alpha_upper_first_ascii,this._alpha_upper_last_ascii]},this._alpha_lower_dict_ranges={lowerCase:[this._alpha_lower_first_ascii,this._alpha_lower_last_ascii]},this._alpha_upper_dict_ranges={upperCase:[this._alpha_upper_first_ascii,this._alpha_upper_last_ascii]},this._alphanum_dict_ranges={digits:[this._digit_first_ascii,this._digit_last_ascii],lowerCase:[this._alpha_lower_first_ascii,this._alpha_lower_last_ascii],upperCase:[this._alpha_upper_first_ascii,this._alpha_upper_last_ascii]},this._alphanum_lower_dict_ranges={digits:[this._digit_first_ascii,this._digit_last_ascii],lowerCase:[this._alpha_lower_first_ascii,this._alpha_lower_last_ascii]},this._alphanum_upper_dict_ranges={digits:[this._digit_first_ascii,this._digit_last_ascii],upperCase:[this._alpha_upper_first_ascii,this._alpha_upper_last_ascii]},this._hex_dict_ranges={decDigits:[this._digit_first_ascii,this._digit_last_ascii],alphaDigits:[this._alpha_lower_first_ascii,this._hex_last_ascii]},this.log=(...e)=>{let h=[...e];if(h[0]=`[short-unique-id] ${e[0]}`,this.debug===!0&&typeof console!="undefined"&&console!==null)return console.log(...h)},this.setDictionary=(e,h)=>{let l;if(e&&Array.isArray(e)&&e.length>1)l=e;else{l=[];let c;this.dictIndex=c=0;let I=`_${e}_dict_ranges`,v=this[I];Object.keys(v).forEach(q=>{let H=q;for(this.dictRange=v[H],this.lowerBound=this.dictRange[0],this.upperBound=this.dictRange[1],this.dictIndex=c=this.lowerBound;this.lowerBound<=this.upperBound?c<this.upperBound:c>this.upperBound;this.dictIndex=this.lowerBound<=this.upperBound?c+=1:c-=1)l.push(String.fromCharCode(this.dictIndex))})}if(h){let c=.5;l=l.sort(()=>Math.random()-c)}this.dict=l,this.dictLength=this.dict.length,this.counter=0},this.seq=()=>this.sequentialUUID(),this.sequentialUUID=()=>{let e,h,l="";e=this.counter;do h=e%this.dictLength,e=Math.trunc(e/this.dictLength),l+=this.dict[h];while(e!==0);return this.counter+=1,l},this.randomUUID=(e=this.uuidLength||f)=>{let h,l,c;if(e===null||typeof e=="undefined"||e<1)throw new Error("Invalid UUID Length Provided");let I=e>=0;for(h="",c=0;c<e;c+=1)l=parseInt((Math.random()*this.dictLength).toFixed(0),10)%this.dictLength,h+=this.dict[l];return h},this.availableUUIDs=(e=this.uuidLength)=>parseFloat(Math.pow([...new Set(this.dict)].length,e).toFixed(0)),this.approxMaxBeforeCollision=(e=this.availableUUIDs(this.uuidLength))=>parseFloat(Math.sqrt(Math.PI/2*e).toFixed(20)),this.collisionProbability=(e=this.availableUUIDs(this.uuidLength),h=this.uuidLength)=>parseFloat((this.approxMaxBeforeCollision(e)/this.availableUUIDs(h)).toFixed(20)),this.uniqueness=(e=this.availableUUIDs(this.uuidLength))=>{let h=parseFloat((1-this.approxMaxBeforeCollision(e)/e).toFixed(20));return h>1?1:h<0?0:h},this.getVersion=()=>this.version,this.stamp=e=>{if(typeof e!="number"||e<10)throw new Error("Param finalLength must be number greater than 10");let h=Math.floor(+new Date/1e3).toString(16),l=e-9,c=Math.round(Math.random()*(l>15?15:l)),I=this.randomUUID(l);return`${I.substr(0,c)}${h}${I.substr(c)}${c.toString(16)}`},this.parseStamp=e=>{if(e.length<10)throw new Error("Stamp length invalid");let h=parseInt(e.substr(e.length-1,1),16);return new Date(parseInt(e.substr(h,8),16)*1e3)};let a=k(k({},y),i);this.counter=0,this.debug=!1,this.dict=[],this.version=r;let{dictionary:u,shuffle:x,length:S}=a;return this.uuidLength=S,this.setDictionary(u,x),this.debug=a.debug,this.log(this.dict),this.log(`Generator instantiated with Dictionary Size ${this.dictLength}`),new Proxy(this,{apply:(e,h,l)=>this.randomUUID(...l)})}},n=m;return n.default=m,w})();typeof A!="undefined"&&(A.exports=Q.default),typeof window!="undefined"&&(Q=Q.default)});var Z={};V(Z,{RTQStatus:()=>g,RTQStatusEnum:()=>D,default:()=>U});var B=z(L());var D;(function(r){r.NEW="NEW",r.QUEUED="QUEUED",r.INITIATED="INITIATED",r.RETRIED="RETRIED",r.IN_PROGRESS="IN_PROGRESS",r.FAILED="FAILED",r.AWAITING_RETRY="AWAITING_RETRY",r.AWAITING_NEXT_RUN="AWAITING_NEXT_RUN",r.SUCCEEDED="SUCCEEDED"})(D||(D={}));var g=E({},D),K={maxConcurrentTasks:0,errorHandler:async s=>console.log(s)},U=class{constructor(t){this.runningTasks=0;this.ticking=!1;this.options=E(E({},K),t),this.uid=new B.default}async changeTaskStatus({task:t,status:o,reason:_,triggeredBy:T,retryCount:k,lastRun:d}){let{options:{updateTask:p,logAction:w,errorHandler:r}}=this,f=P(E({},t),{status:o,retryCount:k||t.retryCount,lastRun:d||t.lastRun});return await p(f).then(()=>(w({timestamp:new Date,action:`changed status of ${t.taskName} to ${o}`,reason:_||"",triggeredBy:T||"RTQ"}).catch(r),f)).catch(y=>(r(y),w({timestamp:new Date,action:`failed changing status of ${t.taskName} to ${o}`,reason:_||"",triggeredBy:T||"RTQ"}).catch(r),null))}async queueTask(t,o,_){let{options:{createQueueEntry:T,errorHandler:k}}=this;return await T({id:this.uid.stamp(16),taskId:t.id,queuedAt:new Date}).catch(p=>(k(p),null))===null?null:await this.changeTaskStatus({task:t,status:g.QUEUED})}async processTask(t,o,_){this.runningTasks+=1;let{taskName:T,taskOptions:k,lastRun:d,waitTimeBetweenRuns:p,retryCount:w,maxRetries:r}=t;if(Date.now().valueOf()-d.valueOf()<p){await this.changeTaskStatus({task:t,status:g.AWAITING_RETRY});return}let{options:{taskHandlers:y,errorHandler:m}}=this,n=g.INITIATED,i=w;i>0&&(n=g.RETRIED);let a=t;a=await this.changeTaskStatus({task:a,status:n,retryCount:i}),a!==null&&(a=await this.changeTaskStatus({task:a,status:g.IN_PROGRESS,lastRun:new Date}),a!==null&&y[T](k).then(async()=>{a=await this.changeTaskStatus({task:a,status:g.SUCCEEDED,retryCount:0})}).catch(async u=>{m&&m(u).catch(console.log);let x=g.AWAITING_RETRY;i>=r&&(x=g.FAILED),i+=1,a=await this.changeTaskStatus({task:a,status:x,retryCount:i,reason:u.message||JSON.stringify(u)})}).finally(()=>{this.runningTasks-=1}))}async tick(){if(this.ticking)return;this.ticking=!0;let{options:{fetchTasks:t,fetchQueueEntries:o,removeQueueEntry:_,maxConcurrentTasks:T,logAction:k,errorHandler:d}}=this,p=await t().catch(d);if(!Array.isArray(p))return;let w=await o().catch(d);if(!Array.isArray(w))return;let r=w.sort((n,i)=>new Date(i.queuedAt).getTime()-new Date(n.queuedAt).getTime()).reduce((n,i)=>((T===0||n.length<T)&&n.push(i),n),[]);await Promise.all(r.map(async n=>await _(n).catch(i=>{d(i),k({timestamp:new Date,action:`failed removing queue entry ${n.id} from queue`,reason:i.message||JSON.stringify(i),triggeredBy:"RTQ"}).catch(d)}))).catch(d);let f=r.map(n=>p.find(i=>i.id===n.taskId)),y=f.length;if(f.forEach((n,i,a)=>this.processTask(n,i,a)),p=await t().catch(d),!Array.isArray(p))return;let m=p.filter(n=>f.findIndex(i=>n.id===i.id)<0).filter(n=>n.status===g.NEW||n.status===g.AWAITING_RETRY||n.status===g.SUCCEEDED);await Promise.all(m.map(async(n,i,a)=>await this.queueTask(n,i,a).catch(u=>(d(u),null)))).then(n=>{this.ticking=!1,y<1&&m.length>0&&!n.includes(null)&&this.tick()}).catch(d)}};U.RTQStatus=g;return Z;})();
'undefined'!=typeof module&&(module.exports=RTQ.default),'undefined'!=typeof window&&(RTQ=RTQ.default);